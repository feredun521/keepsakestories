<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Keepsake Stories</title>
  <script src="qrcode.min.js"></script>
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --accent: #f093fb;
      --accent-alt: #f5576c;
      --success: #38d9a9;
      --danger: #ff6b6b;
      --warning: #ffd43b;
      --dark: #1a1a2e;
      --darker: #16162a;
      --card: #ffffff;
      --text: #2d3436;
      --text-light: #636e72;
      --border: #e2e8f0;
      --glow: rgba(102, 126, 234, 0.4);
      --glow-accent: rgba(240, 147, 251, 0.4);
      --radius: 1.25rem;
      --radius-sm: 0.75rem;
    }
    
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16162a 50%, #0f0f1a 100%);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Animated background */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    .bg-animation .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.5;
      animation: float 20s infinite ease-in-out;
    }
    .bg-animation .orb:nth-child(1) {
      width: 600px;
      height: 600px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      top: -200px;
      left: -200px;
      animation-delay: 0s;
    }
    .bg-animation .orb:nth-child(2) {
      width: 400px;
      height: 400px;
      background: linear-gradient(135deg, var(--accent), var(--accent-alt));
      bottom: -100px;
      right: -100px;
      animation-delay: -5s;
    }
    .bg-animation .orb:nth-child(3) {
      width: 300px;
      height: 300px;
      background: linear-gradient(135deg, var(--success), #20c997);
      top: 50%;
      left: 50%;
      animation-delay: -10s;
    }
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(50px, -50px) scale(1.1); }
      50% { transform: translate(-30px, 30px) scale(0.95); }
      75% { transform: translate(-50px, -30px) scale(1.05); }
    }

    /* Header */
    header {
      background: rgba(26, 26, 46, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
    }
    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      box-shadow: 0 4px 15px var(--glow);
    }
    .logo span {
      background: linear-gradient(135deg, #fff, #a5b4fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    nav { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    nav button {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      padding: 0.6rem 1rem;
      border-radius: 2rem;
      font: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    nav button:hover { 
      background: rgba(255,255,255,0.1);
      color: #fff;
      transform: translateY(-2px);
    }
    nav button.active { 
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-color: transparent;
      color: #fff;
      box-shadow: 0 4px 15px var(--glow);
    }

    /* Main layout */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
      min-height: calc(100vh - 70px);
    }

    /* Pages */
    .page { display: none; animation: fadeIn 0.5s ease; }
    .page.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Home page */
    .hero {
      text-align: center;
      padding: 3rem 1rem;
      max-width: 700px;
      margin: 0 auto;
    }
    .hero-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      margin: 0 auto 2rem;
      box-shadow: 0 10px 40px var(--glow), 0 0 60px var(--glow-accent);
      animation: pulse-glow 3s infinite ease-in-out;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 10px 40px var(--glow), 0 0 60px var(--glow-accent); }
      50% { box-shadow: 0 10px 60px var(--glow), 0 0 80px var(--glow-accent); }
    }
    .hero h1 {
      font-size: 2.25rem;
      font-weight: 800;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }
    .hero p {
      color: rgba(255,255,255,0.6);
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }
    
    .hero-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
      text-align: left;
    }
    .feature-card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 1.25rem;
      border-radius: var(--radius);
      transition: all 0.3s;
    }
    .feature-card:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .feature-card .icon {
      font-size: 1.75rem;
      margin-bottom: 0.75rem;
      display: block;
    }
    .feature-card h3 {
      font-size: 0.9rem;
      color: #fff;
      margin-bottom: 0.25rem;
    }
    .feature-card p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      margin: 0;
    }

    .hero-actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      border-radius: 3rem;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .btn:hover::before { left: 100%; }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      box-shadow: 0 4px 20px var(--glow);
    }
    .btn-primary:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 8px 30px var(--glow);
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
    }
    .btn-secondary:hover { 
      background: rgba(255,255,255,0.15);
      transform: translateY(-3px);
    }
    .btn-sm { padding: 0.6rem 1.25rem; font-size: 0.9rem; }
    .btn-danger { 
      background: linear-gradient(135deg, var(--danger), #ee5a5a);
      color: #fff;
    }
    .btn-success { 
      background: linear-gradient(135deg, var(--success), #20c997);
      color: #fff;
    }
    .btn-nfc {
      background: linear-gradient(135deg, #00d4aa, #00b894);
      color: #fff;
      box-shadow: 0 4px 20px rgba(0, 212, 170, 0.4);
    }
    .btn-scan {
      background: linear-gradient(135deg, #fd79a8, #e84393);
      color: #fff;
      box-shadow: 0 4px 20px rgba(232, 67, 147, 0.4);
    }

    /* Create page */
    .create-container {
      max-width: 520px;
      margin: 0 auto;
    }
    .page-header {
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .page-header h2 {
      font-size: 1.75rem;
      color: #fff;
      margin-bottom: 0.5rem;
    }
    .page-header p {
      color: rgba(255,255,255,0.6);
      font-size: 0.95rem;
    }

    /* Steps indicator */
    .steps {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transition: all 0.4s;
      position: relative;
    }
    .step.active { 
      background: linear-gradient(135deg, var(--primary), var(--accent));
      width: 36px;
      border-radius: 6px;
      box-shadow: 0 0 20px var(--glow-accent);
    }
    .step.done { 
      background: var(--success);
      box-shadow: 0 0 10px rgba(56, 217, 169, 0.5);
    }

    /* Card form */
    .form-card {
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .form-step {
      display: none;
      padding: 2rem;
      animation: slideIn 0.4s ease;
    }
    .form-step.active { display: block; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .form-step h3 {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--dark);
    }
    .form-step > p {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    /* Form fields */
    .field { margin-bottom: 1.25rem; }
    .field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font: inherit;
      font-size: 1rem;
      background: #fff;
      color: var(--text);
      transition: all 0.3s;
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--glow);
    }
    .field-hint {
      font-size: 0.75rem;
      color: var(--text-light);
      margin-top: 0.35rem;
    }
    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* PIN field */
    .pin-field {
      margin-bottom: 1.25rem;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    .pin-field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }
    .pin-input-container {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
    }
    .pin-digit {
      width: 50px;
      height: 60px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: #fff;
      color: var(--dark);
      transition: all 0.3s;
    }
    .pin-digit:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--glow);
    }
    .pin-field .field-hint {
      text-align: center;
      margin-top: 0.75rem;
    }

    /* NFC field */
    .nfc-field {
      margin-bottom: 1.25rem;
      padding: 1rem;
      background: linear-gradient(135deg, #e8fff8, #d0fff0);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(0, 212, 170, 0.3);
    }
    .nfc-field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nfc-status {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: #fff;
      border-radius: var(--radius-sm);
      margin-bottom: 0.75rem;
    }
    .nfc-status .icon {
      font-size: 1.5rem;
    }
    .nfc-status .text {
      flex: 1;
    }
    .nfc-status .text strong {
      display: block;
      font-size: 0.9rem;
      color: var(--dark);
    }
    .nfc-status .text span {
      font-size: 0.75rem;
      color: var(--text-light);
    }
    .nfc-id-display {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 0.9rem;
      color: #00b894;
      background: rgba(0, 184, 148, 0.1);
      padding: 0.5rem;
      border-radius: 0.25rem;
      text-align: center;
      word-break: break-all;
    }

    /* Photo section */
    .photo-section {
      margin-bottom: 1rem;
    }
    .photo-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .photo-option {
      padding: 1rem;
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #fafafa;
    }
    .photo-option:hover {
      border-color: var(--primary);
      background: #f0f0ff;
    }
    .photo-option .icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    .photo-option span {
      font-size: 0.85rem;
      color: var(--text-light);
    }
    .photo-option input { display: none; }
    
    .photo-preview-container {
      display: none;
      position: relative;
      border-radius: var(--radius-sm);
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .photo-preview-container.has-photo { display: block; }
    .photo-preview-container img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
    }
    .photo-remove {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Camera modal */
    .camera-modal {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 500;
      display: none;
      flex-direction: column;
    }
    .camera-modal.active { display: flex; }
    .camera-header {
      padding: 1rem;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    .camera-header h3 {
      color: #fff;
      font-size: 1rem;
      margin: 0;
    }
    .camera-close-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .camera-video-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .camera-modal video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .camera-controls {
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      background: rgba(0,0,0,0.9);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }
    .camera-btn-capture {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 5px solid #fff;
      background: transparent;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    .camera-btn-capture::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: #fff;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .camera-btn-capture:hover::after { background: var(--accent); }
    .camera-btn-capture:active { transform: scale(0.95); }
    .camera-btn-switch {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .camera-btn-switch:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Recording section */
    .record-section {
      background: linear-gradient(135deg, #f8f9ff, #f0f4ff);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    .record-section h4 {
      font-size: 0.95rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--dark);
    }
    .record-btns {
      display: flex;
      gap: 0.75rem;
    }
    .record-btns button {
      flex: 1;
      padding: 1rem;
      border: none;
      border-radius: var(--radius-sm);
      font: inherit;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s;
    }
    .btn-record-audio { 
      background: linear-gradient(135deg, #38d9a9, #20c997);
      color: #fff;
      box-shadow: 0 4px 15px rgba(56, 217, 169, 0.3);
    }
    .btn-record-audio:hover { transform: translateY(-2px); }
    .btn-record-audio.recording { 
      background: linear-gradient(135deg, var(--danger), #ee5a5a);
      animation: recording-pulse 1.5s infinite;
    }
    .btn-record-video { 
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      box-shadow: 0 4px 15px var(--glow);
    }
    .btn-record-video:hover { transform: translateY(-2px); }
    .btn-record-video.recording { 
      background: linear-gradient(135deg, var(--danger), #ee5a5a);
      animation: recording-pulse 1.5s infinite;
    }
    @keyframes recording-pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
      50% { opacity: 0.9; box-shadow: 0 0 0 15px rgba(255, 107, 107, 0); }
    }

    /* Audio visualizer */
    .visualizer-container {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #1a1a2e, #2d2d44);
      border-radius: var(--radius-sm);
      display: none;
    }
    .visualizer-container.active { display: block; }
    .visualizer {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 3px;
      height: 60px;
    }
    .visualizer .bar {
      width: 4px;
      background: linear-gradient(to top, var(--primary), var(--accent));
      border-radius: 2px;
      transition: height 0.05s;
    }
    .recording-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
      color: #fff;
      font-size: 0.85rem;
    }
    .recording-dot {
      width: 10px;
      height: 10px;
      background: var(--danger);
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* Video preview */
    .video-preview {
      margin-top: 1rem;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: #1a1a1a;
      display: none;
    }
    .video-preview.active { display: block; }
    .video-preview video {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
    }

    /* Playback */
    .playback-container {
      margin-top: 1rem;
      display: none;
      background: #fff;
      border-radius: var(--radius-sm);
      padding: 1rem;
      border: 2px solid var(--success);
    }
    .playback-container.active { display: block; }
    .playback-container audio, .playback-container video {
      width: 100%;
      border-radius: var(--radius-sm);
    }
    .playback-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .playback-header span {
      font-size: 0.85rem;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 600;
    }

    /* Form navigation */
    .form-nav {
      display: flex;
      justify-content: space-between;
      padding: 1.25rem 2rem;
      background: #f8f9fa;
      border-top: 1px solid var(--border);
    }

    /* Library page */
    .library-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .library-header h2 { 
      font-size: 1.75rem;
      color: #fff;
    }
    .library-header p {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
    }
    .library-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .library-stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .stat {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 1.25rem 1.75rem;
      border-radius: var(--radius);
      min-width: 100px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    /* Keepsake grid */
    .keepsake-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .keepsake-card {
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
    }
    .keepsake-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1;
      pointer-events: none;
    }
    .keepsake-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 50px rgba(0,0,0,0.3), 0 0 30px var(--glow);
    }
    .keepsake-card:hover::before { opacity: 0.1; }
    .keepsake-thumb {
      aspect-ratio: 4/3;
      background: linear-gradient(135deg, #e0e5ec, #d0d5dc);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .keepsake-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s;
    }
    .keepsake-card:hover .keepsake-thumb img {
      transform: scale(1.05);
    }
    .keepsake-thumb .no-photo {
      font-size: 3.5rem;
      opacity: 0.4;
    }
    .keepsake-badges {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      gap: 0.4rem;
      z-index: 2;
      flex-wrap: wrap;
    }
    .badge {
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 0.3rem 0.6rem;
      border-radius: 2rem;
      font-size: 0.7rem;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .badge.nfc {
      background: rgba(0, 184, 148, 0.9);
    }
    .keepsake-info {
      padding: 1.25rem;
      position: relative;
      z-index: 2;
    }
    .keepsake-info h3 {
      font-size: 1.05rem;
      margin-bottom: 0.35rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--dark);
    }
    .keepsake-meta {
      font-size: 0.8rem;
      color: var(--text-light);
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .keepsake-code {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      background: linear-gradient(135deg, #f0f0ff, #e8e8ff);
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      color: var(--primary);
      font-weight: 600;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }
    .empty-state .icon {
      font-size: 5rem;
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }
    .empty-state h3 {
      color: #fff;
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
    }
    .empty-state p {
      color: rgba(255,255,255,0.5);
    }

    /* Scan Page */
    .scan-container {
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
    }
    .scan-hero {
      padding: 2rem 0;
    }
    .scan-hero h2 {
      font-size: 1.75rem;
      color: #fff;
      margin-bottom: 0.5rem;
    }
    .scan-hero p {
      color: rgba(255,255,255,0.6);
    }
    .scan-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 2rem;
    }
    .scan-option {
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius);
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 1.25rem;
      text-align: left;
    }
    .scan-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    }
    .scan-option .icon-wrap {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      flex-shrink: 0;
    }
    .scan-option.nfc .icon-wrap {
      background: linear-gradient(135deg, #00d4aa, #00b894);
    }
    .scan-option.visual .icon-wrap {
      background: linear-gradient(135deg, #fd79a8, #e84393);
    }
    .scan-option.code .icon-wrap {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }
    .scan-option .info h3 {
      font-size: 1.1rem;
      color: var(--dark);
      margin-bottom: 0.25rem;
    }
    .scan-option .info p {
      font-size: 0.85rem;
      color: var(--text-light);
      margin: 0;
    }
    .scan-option .status {
      margin-left: auto;
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      background: #e0e0e0;
      color: var(--text-light);
    }
    .scan-option .status.available {
      background: rgba(56, 217, 169, 0.2);
      color: #00b894;
    }
    .scan-option .status.unavailable {
      background: rgba(255, 107, 107, 0.2);
      color: var(--danger);
    }

    /* Visual scan modal */
    .visual-scan-modal {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 500;
      display: none;
      flex-direction: column;
    }
    .visual-scan-modal.active { display: flex; }
    .visual-scan-header {
      padding: 1rem;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    .visual-scan-header h3 {
      color: #fff;
      font-size: 1rem;
      margin: 0;
    }
    .visual-scan-video-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .visual-scan-modal video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .scan-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .scan-frame {
      width: 250px;
      height: 250px;
      border: 3px solid rgba(255,255,255,0.5);
      border-radius: var(--radius);
      position: relative;
    }
    .scan-frame::before,
    .scan-frame::after {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      border-color: var(--accent);
      border-style: solid;
    }
    .scan-frame::before {
      top: -3px;
      left: -3px;
      border-width: 3px 0 0 3px;
      border-radius: var(--radius-sm) 0 0 0;
    }
    .scan-frame::after {
      bottom: -3px;
      right: -3px;
      border-width: 0 3px 3px 0;
      border-radius: 0 0 var(--radius-sm) 0;
    }
    .scan-instruction {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 2rem;
      font-size: 0.9rem;
    }
    .visual-scan-controls {
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
      background: rgba(0,0,0,0.9);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }
    .scan-btn-capture {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 5px solid #fff;
      background: linear-gradient(135deg, #fd79a8, #e84393);
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #fff;
    }
    .scan-btn-capture:hover {
      transform: scale(1.05);
    }
    .scan-btn-capture:active { transform: scale(0.95); }
    
    /* Matching results */
    .matching-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 600;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .matching-overlay.active { display: flex; }
    .matching-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .matching-text {
      color: #fff;
      font-size: 1.1rem;
      text-align: center;
    }
    .matching-results {
      width: 100%;
      max-width: 400px;
      max-height: 60vh;
      overflow-y: auto;
      margin-top: 1.5rem;
    }
    .match-item {
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .match-item:hover {
      transform: translateX(5px);
    }
    .match-item img {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-sm);
      object-fit: cover;
    }
    .match-item .no-img {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-sm);
      background: #e0e5ec;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .match-item .info {
      flex: 1;
    }
    .match-item .info h4 {
      font-size: 1rem;
      color: var(--dark);
      margin-bottom: 0.25rem;
    }
    .match-item .info p {
      font-size: 0.8rem;
      color: var(--text-light);
      margin: 0;
    }
    .match-score {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      background: linear-gradient(135deg, var(--success), #20c997);
      color: #fff;
    }
    .no-matches {
      text-align: center;
      padding: 2rem;
    }
    .no-matches .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .no-matches p {
      color: rgba(255,255,255,0.7);
    }

    /* NFC scan modal */
    .nfc-scan-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 500;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .nfc-scan-modal.active { display: flex; }
    .nfc-scan-animation {
      width: 200px;
      height: 200px;
      position: relative;
      margin-bottom: 2rem;
    }
    .nfc-phone {
      font-size: 5rem;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
    .nfc-waves {
      position: absolute;
      inset: 0;
    }
    .nfc-wave {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      border: 3px solid rgba(0, 212, 170, 0.5);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: nfc-pulse 2s infinite ease-out;
    }
    .nfc-wave:nth-child(2) { animation-delay: 0.5s; }
    .nfc-wave:nth-child(3) { animation-delay: 1s; }
    @keyframes nfc-pulse {
      0% {
        width: 80px;
        height: 80px;
        opacity: 1;
      }
      100% {
        width: 200px;
        height: 200px;
        opacity: 0;
      }
    }
    .nfc-scan-text {
      color: #fff;
      font-size: 1.25rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    .nfc-scan-hint {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 2rem;
    }
    .nfc-scan-close {
      padding: 0.75rem 2rem;
    }

    /* Detail Modal with Flip Card */
    .detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      padding: 1rem;
      perspective: 1500px;
    }
    .detail-overlay.active { opacity: 1; pointer-events: auto; }
    
    .flip-card-container {
      width: 100%;
      max-width: 400px;
      aspect-ratio: 3/4;
      max-height: 85vh;
      cursor: pointer;
    }
    
    .flip-card {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .flip-card.flipped {
      transform: rotateY(180deg);
    }
    
    .flip-card-front,
    .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    }
    
    .flip-card-front {
      background: linear-gradient(135deg, #fff, #f8f9ff);
    }
    
    .flip-card-back {
      background: #fff;
      transform: rotateY(180deg);
      overflow-y: auto;
    }
    
    /* Front of card */
    .card-front-photo {
      height: 60%;
      background: linear-gradient(135deg, #e0e5ec, #d0d5dc);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .card-front-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .card-front-photo .no-photo {
      font-size: 5rem;
      opacity: 0.3;
    }
    .card-front-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .card-front-close:hover { background: rgba(0,0,0,0.7); }
    
    .card-front-info {
      height: 40%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
    }
    .card-front-info h2 {
      font-size: 1.5rem;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }
    .card-front-code {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 1.5rem;
      letter-spacing: 0.15em;
      color: var(--primary);
      background: linear-gradient(135deg, #f0f0ff, #e8e8ff);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      display: inline-block;
      margin: 0.75rem auto;
    }
    .card-front-badges {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .card-front-badges .badge {
      background: rgba(0,0,0,0.1);
      color: var(--text);
    }
    .card-front-badges .badge.nfc {
      background: rgba(0, 184, 148, 0.2);
      color: #00b894;
    }
    .card-front-hint {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .tap-icon {
      display: inline-block;
      animation: tap-hint 1.5s infinite;
    }
    @keyframes tap-hint {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    /* Back of card */
    .card-back-header {
      padding: 1.25rem;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-back-header h3 {
      font-size: 1.1rem;
      margin: 0;
    }
    .card-back-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-back-close:hover { background: rgba(255,255,255,0.3); }
    
    .card-back-body {
      padding: 1.25rem;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
    }
    .detail-row:last-child { border: none; }
    .detail-row .label { 
      color: var(--text-light); 
      font-size: 0.85rem;
    }
    .detail-row .value { 
      font-weight: 600; 
      color: var(--dark);
      text-align: right;
      max-width: 60%;
      font-size: 0.9rem;
    }
    
    .detail-media {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .detail-media h4 {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .detail-media audio, .detail-media video {
      width: 100%;
      border-radius: var(--radius-sm);
      max-height: 200px;
    }
    
    .card-back-actions {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
      padding: 1rem 1.25rem;
      background: #f8f9fa;
      border-top: 1px solid var(--border);
    }
    .detail-action-btn {
      padding: 0.6rem 0.25rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: #fff;
      font: inherit;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
    }
    .detail-action-btn:hover { 
      background: #f0f0ff;
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .detail-action-btn .icon { font-size: 1.25rem; }
    .detail-action-btn.danger { color: var(--danger); }
    .detail-action-btn.danger:hover { 
      background: #fff0f0;
      border-color: var(--danger);
    }
    .detail-action-btn.nfc-btn { color: #00b894; }
    .detail-action-btn.nfc-btn:hover {
      background: #e8fff8;
      border-color: #00b894;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      padding: 1rem;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal {
      background: #fff;
      border-radius: var(--radius);
      max-width: 450px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 80px rgba(0,0,0,0.4);
      animation: modalIn 0.4s ease;
    }
    @keyframes modalIn {
      from { transform: scale(0.9) translateY(20px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }
    .modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { font-size: 1.15rem; color: var(--dark); }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.75rem;
      cursor: pointer;
      color: var(--text-light);
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }
    .modal-close:hover { color: var(--danger); }
    .modal-body { padding: 1.5rem; }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    /* QR display */
    .qr-display {
      text-align: center;
      padding: 1rem;
    }
    .qr-display #qrContainer {
      display: inline-block;
      background: #fff;
      padding: 1rem;
      border-radius: var(--radius-sm);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .qr-display #qrContainer canvas,
    .qr-display #qrContainer img {
      display: block;
    }
    .qr-code-value {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 1.75rem;
      letter-spacing: 0.2em;
      margin: 1.25rem 0;
      padding: 0.75rem;
      background: linear-gradient(135deg, #f0f0ff, #e8e8ff);
      border-radius: var(--radius-sm);
      color: var(--primary);
      font-weight: 700;
    }
    .qr-display > p {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    /* Export options */
    .export-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .export-option {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s;
    }
    .export-option:hover { 
      border-color: var(--primary);
      background: #f8f9ff;
      transform: translateX(5px);
    }
    .export-option .icon {
      font-size: 2rem;
      width: 50px;
      text-align: center;
    }
    .export-option .info h4 {
      font-size: 1rem;
      margin-bottom: 0.2rem;
      color: var(--dark);
    }
    .export-option .info p {
      font-size: 0.85rem;
      color: var(--text-light);
      margin: 0;
    }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 2.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
    }
    .drop-zone .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .drop-zone p { color: var(--text-light); font-size: 0.95rem; margin: 0; }
    .drop-zone input { display: none; }

    /* PIN Modal */
    .pin-modal-body {
      text-align: center;
      padding: 2rem;
    }
    .pin-modal-body p {
      color: var(--text-light);
      margin-bottom: 1.5rem;
    }
    .pin-modal-body .pin-input-container {
      margin-bottom: 1.5rem;
    }
    .pin-error {
      color: var(--danger);
      font-size: 0.9rem;
      margin-top: 1rem;
      display: none;
    }
    .pin-error.visible {
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(135deg, var(--dark), var(--darker));
      color: #fff;
      padding: 1rem 1.75rem;
      border-radius: 3rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 400;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: linear-gradient(135deg, var(--success), #20c997); }
    .toast.error { background: linear-gradient(135deg, var(--danger), #ee5a5a); }

    /* Responsive */
    @media (max-width: 600px) {
      header { padding: 0.75rem 1rem; }
      .logo { font-size: 1rem; }
      .logo-icon { width: 32px; height: 32px; font-size: 1rem; }
      nav button { padding: 0.5rem 0.6rem; font-size: 0.75rem; }
      main { padding: 1rem; }
      .hero { padding: 1.5rem 0.5rem; }
      .hero h1 { font-size: 1.5rem; }
      .hero-icon { width: 70px; height: 70px; font-size: 2rem; }
      .keepsake-grid { grid-template-columns: 1fr; }
      .field-row { grid-template-columns: 1fr; }
      .card-back-actions { grid-template-columns: repeat(5, 1fr); }
      .flip-card-container {
        max-width: 340px;
      }
      .pin-digit {
        width: 45px;
        height: 55px;
        font-size: 1.25rem;
      }
      .scan-option {
        flex-direction: column;
        text-align: center;
      }
      .scan-option .status {
        margin-left: 0;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <!-- Animated background -->
  <div class="bg-animation">
    <div class="orb"></div>
    <div class="orb"></div>
    <div class="orb"></div>
  </div>

  <!-- Header -->
  <header>
    <div class="logo">
      <div class="logo-icon">âœ¨</div>
      <span>Keepsake Stories</span>
    </div>
    <nav>
      <button id="navHome" class="active" onclick="showPage('home')">Home</button>
      <button id="navCreate" onclick="showPage('create')">Create</button>
      <button id="navScan" onclick="showPage('scan')">Scan</button>
      <button id="navLibrary" onclick="showPage('library')">Library</button>
    </nav>
  </header>

  <main>
    <!-- Home Page -->
    <section id="pageHome" class="page active">
      <div class="hero">
        <div class="hero-icon">ðŸ“¦</div>
        <h1>Stories behind the things you treasure</h1>
        <p>Attach audio and video memories to your keepsakes. Tap NFC or scan to hear the story.</p>
        
        <div class="hero-features">
          <div class="feature-card">
            <span class="icon">ðŸ“¡</span>
            <h3>NFC Tags</h3>
            <p>Tap your phone to any tagged item</p>
          </div>
          <div class="feature-card">
            <span class="icon">ðŸ“·</span>
            <h3>Visual Scan</h3>
            <p>Point camera at item to find it</p>
          </div>
          <div class="feature-card">
            <span class="icon">ðŸŽ¤</span>
            <h3>Voice Stories</h3>
            <p>Record in your own voice</p>
          </div>
          <div class="feature-card">
            <span class="icon">ðŸŽ¬</span>
            <h3>Video</h3>
            <p>Capture video memories</p>
          </div>
        </div>

        <div class="hero-actions">
          <button class="btn btn-primary" onclick="showPage('create')">
            âœ¨ Create your first keepsake
          </button>
          <button class="btn btn-scan" onclick="showPage('scan')">
            ðŸ“· Scan to find a keepsake
          </button>
        </div>
      </div>
    </section>

    <!-- Create Page -->
    <section id="pageCreate" class="page">
      <div class="create-container">
        <div class="page-header">
          <h2>Create a Keepsake</h2>
          <p>Capture the story behind something special</p>
        </div>

        <div class="steps">
          <div class="step active" data-step="1"></div>
          <div class="step" data-step="2"></div>
          <div class="step" data-step="3"></div>
          <div class="step" data-step="4"></div>
        </div>

        <div class="form-card">
          <!-- Step 1: Basic Info -->
          <div class="form-step active" data-step="1">
            <h3>ðŸ“ Basic Information</h3>
            <p>What is this keepsake and where did it come from?</p>

            <div class="field">
              <label for="itemName">What is it? *</label>
              <input type="text" id="itemName" placeholder="e.g., Grandma's music box, Dad's watch">
            </div>

            <div class="field-row">
              <div class="field">
                <label for="itemYear">Year / Date</label>
                <input type="text" id="itemYear" placeholder="e.g., 1985">
              </div>
              <div class="field">
                <label for="itemFrom">From whom?</label>
                <input type="text" id="itemFrom" placeholder="e.g., Grandma Rose">
              </div>
            </div>

            <div class="field">
              <label for="itemCategory">Category</label>
              <select id="itemCategory">
                <option value="">Select a category</option>
                <option value="heirloom">Family Heirloom</option>
                <option value="gift">Gift</option>
                <option value="travel">Travel Souvenir</option>
                <option value="holiday">Holiday Item</option>
                <option value="art">Art / Craft</option>
                <option value="jewelry">Jewelry</option>
                <option value="photo">Photo / Album</option>
                <option value="clothing">Clothing / Accessory</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="field">
              <label for="itemNote">Short note (optional)</label>
              <textarea id="itemNote" rows="2" placeholder="Any quick notes about this item..."></textarea>
            </div>

            <div class="pin-field">
              <label>ðŸ”’ Set a 4-digit PIN to protect this keepsake</label>
              <div class="pin-input-container">
                <input type="tel" class="pin-digit" maxlength="1" data-index="0" id="createPin0">
                <input type="tel" class="pin-digit" maxlength="1" data-index="1" id="createPin1">
                <input type="tel" class="pin-digit" maxlength="1" data-index="2" id="createPin2">
                <input type="tel" class="pin-digit" maxlength="1" data-index="3" id="createPin3">
              </div>
              <div class="field-hint">You'll need this PIN to edit or delete this keepsake later</div>
            </div>
          </div>

          <!-- Step 2: Photo & NFC -->
          <div class="form-step" data-step="2">
            <h3>ðŸ“· Add a Photo</h3>
            <p>Take a picture of your keepsake (used for visual scanning too!)</p>

            <div class="photo-section">
              <div class="photo-options" id="photoOptions">
                <div class="photo-option" onclick="openCamera()">
                  <span class="icon">ðŸ“¸</span>
                  <span>Take Photo</span>
                </div>
                <label class="photo-option">
                  <input type="file" accept="image/*" onchange="handlePhotoUpload(event)">
                  <span class="icon">ðŸ–¼ï¸</span>
                  <span>Choose File</span>
                </label>
              </div>
              
              <div class="photo-preview-container" id="photoPreviewContainer">
                <img id="photoPreview" alt="Keepsake photo">
                <button class="photo-remove" onclick="clearPhoto()">Ã—</button>
              </div>
            </div>

            <div class="nfc-field" id="nfcFieldSection">
              <label>ðŸ“¡ Link NFC Tag (optional)</label>
              <div class="nfc-status" id="nfcStatus">
                <span class="icon">ðŸ“¡</span>
                <div class="text">
                  <strong id="nfcStatusText">No NFC tag linked</strong>
                  <span id="nfcStatusHint">Tap button below to scan an NFC tag</span>
                </div>
              </div>
              <div class="nfc-id-display" id="nfcIdDisplay" style="display: none;"></div>
              <button type="button" class="btn btn-nfc btn-sm" onclick="scanNfcForCreate()" id="btnScanNfc" style="width: 100%; margin-top: 0.5rem;">
                ðŸ“¡ Scan NFC Tag
              </button>
              <div class="field-hint" style="margin-top: 0.5rem;">Place an NFC sticker on your keepsake, then scan it here to link them</div>
            </div>
          </div>

          <!-- Step 3: Story -->
          <div class="form-step" data-step="3">
            <h3>ðŸŽ™ï¸ Record the Story</h3>
            <p>Capture the memory in your voice or on video</p>

            <div class="field">
              <label for="speakerName">Who is telling this story?</label>
              <input type="text" id="speakerName" placeholder="e.g., Mom, Grandpa Joe, Me">
              <div class="field-hint">Helps identify the voice years from now</div>
            </div>

            <div class="record-section">
              <h4>ðŸŽ¤ Voice Recording</h4>
              <div class="record-btns">
                <button type="button" class="btn-record-audio" id="btnRecordAudio" onclick="toggleAudioRecording()">
                  ðŸŽ¤ Record Audio
                </button>
              </div>
              <div class="visualizer-container" id="audioVisualizerContainer">
                <div class="visualizer" id="audioVisualizer"></div>
                <div class="recording-status">
                  <span class="recording-dot"></span>
                  <span id="audioTimer">Recording... 0:00</span>
                </div>
              </div>
              <div class="playback-container" id="audioPlayback">
                <div class="playback-header">
                  <span>âœ“ Audio recorded</span>
                  <button class="btn btn-sm btn-secondary" onclick="clearAudio()">Remove</button>
                </div>
                <audio id="audioPlayer" controls=""></audio>
              </div>
            </div>

            <div class="record-section">
              <h4>ðŸŽ¬ Video Recording</h4>
              <div class="record-btns">
                <button type="button" class="btn-record-video" id="btnRecordVideo" onclick="toggleVideoRecording()">
                  ðŸŽ¥ Record Video
                </button>
              </div>
              <div class="video-preview" id="videoPreviewContainer">
                <video id="videoPreviewLive" autoplay="" muted="" playsinline=""></video>
              </div>
              <div class="playback-container" id="videoPlayback">
                <div class="playback-header">
                  <span>âœ“ Video recorded</span>
                  <button class="btn btn-sm btn-secondary" onclick="clearVideo()">Remove</button>
                </div>
                <video id="videoPlayer" controls="" playsinline=""></video>
              </div>
            </div>
          </div>

          <!-- Step 4: Review -->
          <div class="form-step" data-step="4">
            <h3>âœ… Review &amp; Save</h3>
            <p>Review your keepsake before saving</p>
            
            <div id="reviewContent" style="background: #f8f9fa; border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem;">
              <!-- Filled dynamically -->
            </div>
          </div>

          <!-- Form Navigation -->
          <div class="form-nav">
            <button class="btn btn-secondary" id="btnPrev" onclick="prevStep()" style="visibility: hidden;">
              â† Back
            </button>
            <button class="btn btn-primary" id="btnNext" onclick="nextStep()">
              Next â†’
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Scan Page -->
    <section id="pageScan" class="page">
      <div class="scan-container">
        <div class="scan-hero">
          <h2>Find Your Keepsake</h2>
          <p>Choose how you want to identify your item</p>
        </div>

        <div class="scan-options">
          <div class="scan-option nfc" onclick="startNfcScan()">
            <div class="icon-wrap">ðŸ“¡</div>
            <div class="info">
              <h3>NFC Tap</h3>
              <p>Hold your phone near the NFC tag on your item</p>
            </div>
            <span class="status" id="nfcAvailability">Checking...</span>
          </div>

          <div class="scan-option visual" onclick="startVisualScan()">
            <div class="icon-wrap">ðŸ“·</div>
            <div class="info">
              <h3>Visual Scan</h3>
              <p>Point your camera at the item to find matches</p>
            </div>
            <span class="status available">Available</span>
          </div>

          <div class="scan-option code" onclick="openCodeLookup()">
            <div class="icon-wrap">ðŸ”¤</div>
            <div class="info">
              <h3>Enter Code</h3>
              <p>Type the 6-character code from the QR label</p>
            </div>
            <span class="status available">Available</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Library Page -->
    <section id="pageLibrary" class="page">
      <div class="library-header">
        <div>
          <h2>Your Library</h2>
          <p>All your keepsake stories in one place</p>
        </div>
        <div class="library-actions">
          <button class="btn btn-sm btn-secondary" onclick="openImportModal()">
            ðŸ“¥ Import
          </button>
          <button class="btn btn-sm btn-secondary" onclick="openExportModal()">
            ðŸ“¤ Export
          </button>
        </div>
      </div>

      <div class="library-stats" id="libraryStats">
        <div class="stat">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Keepsakes</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="statNfc">0</div>
          <div class="stat-label">NFC Tagged</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="statAudio">0</div>
          <div class="stat-label">With Audio</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="statVideo">0</div>
          <div class="stat-label">With Video</div>
        </div>
      </div>

      <div class="keepsake-grid" id="keepsakeGrid"></div>

      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="icon">ðŸ“¦</div>
        <h3>No keepsakes yet</h3>
        <p>Start by creating your first keepsake story</p>
        <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="showPage('create')">
          âœ¨ Create one now
        </button>
      </div>
    </section>
  </main>

  <!-- Camera Modal -->
  <div class="camera-modal" id="cameraModal">
    <div class="camera-header">
      <h3>ðŸ“¸ Take a Photo</h3>
      <button class="camera-close-btn" onclick="closeCamera()">Ã—</button>
    </div>
    <div class="camera-video-container">
      <video id="cameraVideo" autoplay="" playsinline=""></video>
    </div>
    <div class="camera-controls">
      <button class="camera-btn-switch" onclick="switchCamera()" title="Switch Camera">ðŸ”„</button>
      <button class="camera-btn-capture" onclick="capturePhoto()" title="Take Photo"></button>
      <div style="width: 50px;"></div>
    </div>
  </div>

  <!-- Visual Scan Modal -->
  <div class="visual-scan-modal" id="visualScanModal">
    <div class="visual-scan-header">
      <h3>ðŸ“· Visual Scan</h3>
      <button class="camera-close-btn" onclick="closeVisualScan()">Ã—</button>
    </div>
    <div class="visual-scan-video-container">
      <video id="visualScanVideo" autoplay="" playsinline=""></video>
      <div class="scan-overlay">
        <div class="scan-frame"></div>
      </div>
      <div class="scan-instruction">Point at your keepsake</div>
    </div>
    <div class="visual-scan-controls">
      <button class="scan-btn-capture" onclick="captureForVisualMatch()" title="Capture &amp; Search">ðŸ”</button>
    </div>
  </div>

  <!-- NFC Scan Modal -->
  <div class="nfc-scan-modal" id="nfcScanModal">
    <div class="nfc-scan-animation">
      <div class="nfc-waves">
        <div class="nfc-wave"></div>
        <div class="nfc-wave"></div>
        <div class="nfc-wave"></div>
      </div>
      <div class="nfc-phone">ðŸ“±</div>
    </div>
    <div class="nfc-scan-text">Ready to Scan</div>
    <div class="nfc-scan-hint">Hold your phone near the NFC tag on your keepsake</div>
    <button class="btn btn-secondary nfc-scan-close" onclick="closeNfcScan()">Cancel</button>
  </div>

  <!-- Matching Overlay -->
  <div class="matching-overlay" id="matchingOverlay">
    <div class="matching-spinner" id="matchingSpinner"></div>
    <div class="matching-text" id="matchingText">Analyzing image...</div>
    <div class="matching-results" id="matchingResults"></div>
    <button class="btn btn-secondary" onclick="closeMatchingOverlay()" style="margin-top: 1rem;">Close</button>
  </div>

  <!-- Detail Modal with Flip Card -->
  <div class="detail-overlay" id="detailOverlay" onclick="closeDetail()">
    <div class="flip-card-container" onclick="event.stopPropagation()">
      <div class="flip-card" id="flipCard">
        <!-- Front of Card -->
        <div class="flip-card-front" onclick="flipCard()">
          <div class="card-front-photo" id="cardFrontPhoto">
            <button class="card-front-close" onclick="event.stopPropagation(); closeDetail()">Ã—</button>
            <span class="no-photo">ðŸ“¦</span>
          </div>
          <div class="card-front-info">
            <h2 id="cardFrontName">Item Name</h2>
            <div class="card-front-code" id="cardFrontCode">ABC123</div>
            <div class="card-front-badges" id="cardFrontBadges"></div>
            <div class="card-front-hint">
              <span class="tap-icon">ðŸ‘†</span> Tap to see the story
            </div>
          </div>
        </div>
        
        <!-- Back of Card -->
        <div class="flip-card-back" onclick="event.stopPropagation()">
          <div class="card-back-header">
            <h3>ðŸ“– The Story</h3>
            <button class="card-back-close" onclick="flipCard()">â†©</button>
          </div>
          <div class="card-back-body">
            <div id="detailRows"></div>
            
            <div class="detail-media" id="detailAudioSection" style="display: none;">
              <h4>ðŸŽ§ Listen</h4>
              <audio id="detailAudio" controls=""></audio>
            </div>
            
            <div class="detail-media" id="detailVideoSection" style="display: none;">
              <h4>ðŸŽ¬ Watch</h4>
              <video id="detailVideo" controls="" playsinline=""></video>
            </div>
          </div>
          <div class="card-back-actions">
            <button class="detail-action-btn" onclick="showQrForCurrent()">
              <span class="icon">ðŸ“±</span>
              QR
            </button>
            <button class="detail-action-btn nfc-btn" onclick="writeNfcForCurrent()" id="detailNfcBtn">
              <span class="icon">ðŸ“¡</span>
              NFC
            </button>
            <button class="detail-action-btn" onclick="exportSingle()">
              <span class="icon">ðŸ“¤</span>
              Export
            </button>
            <button class="detail-action-btn" onclick="promptPinForEdit()">
              <span class="icon">âœï¸</span>
              Edit
            </button>
            <button class="detail-action-btn danger" onclick="promptPinForDelete()">
              <span class="icon">ðŸ—‘ï¸</span>
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal-overlay" id="qrModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>QR Code</h3>
        <button class="modal-close" onclick="closeModal('qrModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="qr-display">
          <div id="qrContainer"></div>
          <div class="qr-code-value" id="qrCodeValue">ABC123</div>
          <p>Print this QR code and attach it to your keepsake. Scan it anytime to hear the story.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="copyCode()">ðŸ“‹ Copy Code</button>
        <button class="btn btn-primary" onclick="downloadQR()">ðŸ“¥ Download</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>Export Your Library</h3>
        <button class="modal-close" onclick="closeModal('exportModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1.25rem; color: var(--text-light);">
          Download a backup of all your keepsakes including photos, audio, and video.
        </p>
        <div class="export-options">
          <div class="export-option" onclick="exportAll()">
            <div class="icon">ðŸ“¦</div>
            <div class="info">
              <h4>Full Backup (JSON)</h4>
              <p>All data including media. Can be imported back later.</p>
            </div>
          </div>
          <div class="export-option" onclick="exportList()">
            <div class="icon">ðŸ“„</div>
            <div class="info">
              <h4>List Only (CSV)</h4>
              <p>Spreadsheet with names, codes, and details. No media.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal-overlay" id="importModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>Import Keepsakes</h3>
        <button class="modal-close" onclick="closeModal('importModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1.25rem; color: var(--text-light);">
          Restore from a backup file or import shared keepsakes.
        </p>
        <label class="drop-zone" id="importDropZone">
          <input type="file" accept=".json" onchange="handleImport(event)">
          <div class="icon">ðŸ“¥</div>
          <p>Drop a .json backup file here or tap to browse</p>
        </label>
      </div>
    </div>
  </div>

  <!-- Code Lookup Modal -->
  <div class="modal-overlay" id="codeLookupModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>Lookup by Code</h3>
        <button class="modal-close" onclick="closeModal('codeLookupModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem; color: var(--text-light);">
          Enter a keepsake code to view its story
        </p>
        <div class="field">
          <input type="text" id="codeLookupInput" placeholder="Enter code (e.g., ABC123)" style="text-transform: uppercase; letter-spacing: 0.15em; text-align: center; font-size: 1.25rem;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('codeLookupModal')">Cancel</button>
        <button class="btn btn-primary" onclick="lookupCode()">Find Keepsake</button>
      </div>
    </div>
  </div>

  <!-- PIN Verification Modal -->
  <div class="modal-overlay" id="pinModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>ðŸ”’ Enter PIN</h3>
        <button class="modal-close" onclick="closeModal('pinModal')">Ã—</button>
      </div>
      <div class="pin-modal-body">
        <p id="pinModalMessage">Enter the 4-digit PIN to continue</p>
        <div class="pin-input-container">
          <input type="tel" class="pin-digit" maxlength="1" data-index="0" id="verifyPin0">
          <input type="tel" class="pin-digit" maxlength="1" data-index="1" id="verifyPin1">
          <input type="tel" class="pin-digit" maxlength="1" data-index="2" id="verifyPin2">
          <input type="tel" class="pin-digit" maxlength="1" data-index="3" id="verifyPin3">
        </div>
        <p class="pin-error" id="pinError">Incorrect PIN. Please try again.</p>
        <button class="btn btn-primary" onclick="verifyPin()" style="margin-top: 1rem;">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>âœï¸ Edit Keepsake</h3>
        <button class="modal-close" onclick="closeModal('editModal')">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="editName">What is it?</label>
          <input type="text" id="editName">
        </div>
        <div class="field-row">
          <div class="field">
            <label for="editYear">Year / Date</label>
            <input type="text" id="editYear">
          </div>
          <div class="field">
            <label for="editFrom">From whom?</label>
            <input type="text" id="editFrom">
          </div>
        </div>
        <div class="field">
          <label for="editCategory">Category</label>
          <select id="editCategory">
            <option value="">Select a category</option>
            <option value="heirloom">Family Heirloom</option>
            <option value="gift">Gift</option>
            <option value="travel">Travel Souvenir</option>
            <option value="holiday">Holiday Item</option>
            <option value="art">Art / Craft</option>
            <option value="jewelry">Jewelry</option>
            <option value="photo">Photo / Album</option>
            <option value="clothing">Clothing / Accessory</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field">
          <label for="editNote">Short note</label>
          <textarea id="editNote" rows="2"></textarea>
        </div>
        <div class="field">
          <label for="editSpeaker">Who is telling this story?</label>
          <input type="text" id="editSpeaker">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    /* ===========================
       IndexedDB
       =========================== */
    const DB_NAME = 'KeepsakeStoriesDB';
    const DB_VERSION = 2;
    const STORE = 'keepsakes';
    let db = null;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
          const d = e.target.result;
          if (!d.objectStoreNames.contains(STORE)) {
            const store = d.createObjectStore(STORE, { keyPath: 'code' });
            store.createIndex('nfcId', 'nfcId', { unique: false });
          } else {
            const tx = e.target.transaction;
            const store = tx.objectStore(STORE);
            if (!store.indexNames.contains('nfcId')) {
              store.createIndex('nfcId', 'nfcId', { unique: false });
            }
          }
        };
        req.onsuccess = e => { db = e.target.result; resolve(db); };
        req.onerror = e => reject(e.target.error);
      });
    }

    function dbPut(item) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readwrite');
        tx.objectStore(STORE).put(item);
        tx.oncomplete = () => resolve();
        tx.onerror = e => reject(e.target.error);
      });
    }

    function dbGetAll() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readonly');
        const req = tx.objectStore(STORE).getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    function dbGet(code) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readonly');
        const req = tx.objectStore(STORE).get(code);
        req.onsuccess = () => resolve(req.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    function dbGetByNfc(nfcId) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readonly');
        const index = tx.objectStore(STORE).index('nfcId');
        const req = index.get(nfcId);
        req.onsuccess = () => resolve(req.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    function dbDelete(code) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readwrite');
        tx.objectStore(STORE).delete(code);
        tx.oncomplete = () => resolve();
        tx.onerror = e => reject(e.target.error);
      });
    }

    /* ===========================
       State
       =========================== */
    let currentStep = 1;
    const totalSteps = 4;
    let currentPhoto = null;
    let currentPhotoFeatures = null;
    let currentAudioBlob = null;
    let currentVideoBlob = null;
    let currentNfcId = null;
    let isRecordingAudio = false;
    let isRecordingVideo = false;
    let mediaRecorder = null;
    let recordedChunks = [];
    let mediaStream = null;
    let audioContext = null;
    let analyser = null;
    let animationId = null;
    let currentKeepsake = null;
    let currentQRCode = null;
    let recordingStartTime = null;
    let timerInterval = null;
    let cameraStream = null;
    let facingMode = 'environment';
    let pendingPinAction = null;
    let detailVideoBlobUrl = null;
    let nfcSupported = false;
    let nfcReader = null;
    let nfcAbortController = null;
    let visualScanStream = null;
    let nfcScanMode = null; // 'create', 'read', 'write'

    /* ===========================
       NFC Support
       =========================== */
    async function checkNfcSupport() {
      if ('NDEFReader' in window) {
        nfcSupported = true;
        document.getElementById('nfcAvailability').textContent = 'Available';
        document.getElementById('nfcAvailability').classList.add('available');
      } else {
        nfcSupported = false;
        document.getElementById('nfcAvailability').textContent = 'Not supported';
        document.getElementById('nfcAvailability').classList.add('unavailable');
        document.getElementById('nfcFieldSection').style.display = 'none';
      }
    }

    async function scanNfcForCreate() {
      if (!nfcSupported) {
        showToast('NFC not supported on this device', 'error');
        return;
      }

      nfcScanMode = 'create';
      
      try {
        nfcAbortController = new AbortController();
        nfcReader = new NDEFReader();
        
        document.getElementById('nfcScanModal').classList.add('active');
        document.querySelector('.nfc-scan-text').textContent = 'Ready to Scan';
        document.querySelector('.nfc-scan-hint').textContent = 'Hold your phone near the NFC tag';
        
        await nfcReader.scan({ signal: nfcAbortController.signal });
        
        nfcReader.onreading = event => {
          const serialNumber = event.serialNumber;
          currentNfcId = serialNumber;
          
          document.getElementById('nfcStatusText').textContent = 'NFC tag linked!';
          document.getElementById('nfcStatusHint').textContent = 'Tag will be associated with this keepsake';
          document.getElementById('nfcIdDisplay').textContent = serialNumber;
          document.getElementById('nfcIdDisplay').style.display = 'block';
          document.getElementById('btnScanNfc').textContent = 'ðŸ“¡ Change NFC Tag';
          
          closeNfcScan();
          showToast('NFC tag linked successfully!', 'success');
        };

        nfcReader.onreadingerror = () => {
          showToast('Error reading NFC tag', 'error');
        };

      } catch (err) {
        console.error('NFC Error:', err);
        if (err.name !== 'AbortError') {
          showToast('NFC error: ' + err.message, 'error');
        }
        closeNfcScan();
      }
    }

    async function startNfcScan() {
      if (!nfcSupported) {
        showToast('NFC not supported on this device', 'error');
        return;
      }

      nfcScanMode = 'read';
      
      try {
        nfcAbortController = new AbortController();
        nfcReader = new NDEFReader();
        
        document.getElementById('nfcScanModal').classList.add('active');
        document.querySelector('.nfc-scan-text').textContent = 'Scanning for NFC...';
        document.querySelector('.nfc-scan-hint').textContent = 'Hold your phone near your keepsake\'s NFC tag';
        
        await nfcReader.scan({ signal: nfcAbortController.signal });
        
        nfcReader.onreading = async event => {
          const serialNumber = event.serialNumber;
          closeNfcScan();
          
          // Look up in database
          const item = await dbGetByNfc(serialNumber);
          if (item) {
            openDetail(item.code);
            showToast('Keepsake found!', 'success');
          } else {
            // Check if there's a record in the NFC message
            for (const record of event.message.records) {
              if (record.recordType === 'text') {
                const textDecoder = new TextDecoder();
                const code = textDecoder.decode(record.data);
                const itemByCode = await dbGet(code);
                if (itemByCode) {
                  openDetail(code);
                  showToast('Keepsake found!', 'success');
                  return;
                }
              }
            }
            showToast('No keepsake found for this NFC tag', 'error');
          }
        };

        nfcReader.onreadingerror = () => {
          showToast('Error reading NFC tag', 'error');
        };

      } catch (err) {
        console.error('NFC Error:', err);
        if (err.name !== 'AbortError') {
          showToast('NFC error: ' + err.message, 'error');
        }
        closeNfcScan();
      }
    }

    async function writeNfcForCurrent() {
      if (!nfcSupported) {
        showToast('NFC not supported on this device', 'error');
        return;
      }

      if (!currentKeepsake) return;

      nfcScanMode = 'write';
      
      try {
        nfcAbortController = new AbortController();
        nfcReader = new NDEFReader();
        
        document.getElementById('nfcScanModal').classList.add('active');
        document.querySelector('.nfc-scan-text').textContent = 'Ready to Write';
        document.querySelector('.nfc-scan-hint').textContent = 'Hold your phone near an NFC tag to write the keepsake code';
        
        await nfcReader.scan({ signal: nfcAbortController.signal });
        
        nfcReader.onreading = async event => {
          const serialNumber = event.serialNumber;
          
          try {
            await nfcReader.write({
              records: [{ recordType: 'text', data: currentKeepsake.code }]
            });
            
            // Update the keepsake with NFC ID
            currentKeepsake.nfcId = serialNumber;
            await dbPut(currentKeepsake);
            
            closeNfcScan();
            showToast('NFC tag written successfully!', 'success');
            renderLibrary();
          } catch (writeErr) {
            showToast('Error writing to NFC tag', 'error');
          }
        };

      } catch (err) {
        console.error('NFC Error:', err);
        if (err.name !== 'AbortError') {
          showToast('NFC error: ' + err.message, 'error');
        }
        closeNfcScan();
      }
    }

    function closeNfcScan() {
      if (nfcAbortController) {
        nfcAbortController.abort();
        nfcAbortController = null;
      }
      document.getElementById('nfcScanModal').classList.remove('active');
    }

    /* ===========================
       Visual Recognition
       =========================== */
    // Simple image feature extraction using color histogram and edge detection
    function extractImageFeatures(imageData) {
      const data = imageData.data;
      const width = imageData.width;
      const height = imageData.height;
      
      // Color histogram (simplified - 8 bins per channel)
      const colorBins = 8;
      const colorHist = new Array(colorBins * 3).fill(0);
      
      // Calculate average brightness and color distribution
      let totalBrightness = 0;
      const gridSize = 4;
      const gridBrightness = new Array(gridSize * gridSize).fill(0);
      
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = (y * width + x) * 4;
          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];
          
          // Color histogram
          colorHist[Math.floor(r / 32)]++;
          colorHist[colorBins + Math.floor(g / 32)]++;
          colorHist[colorBins * 2 + Math.floor(b / 32)]++;
          
          // Brightness
          const brightness = (r + g + b) / 3;
          totalBrightness += brightness;
          
          // Grid-based brightness
          const gridX = Math.floor(x / (width / gridSize));
          const gridY = Math.floor(y / (height / gridSize));
          const gridIdx = gridY * gridSize + gridX;
          if (gridIdx < gridBrightness.length) {
            gridBrightness[gridIdx] += brightness;
          }
        }
      }
      
      // Normalize
      const totalPixels = width * height;
      const pixelsPerGrid = totalPixels / (gridSize * gridSize);
      
      for (let i = 0; i < colorHist.length; i++) {
        colorHist[i] /= totalPixels;
      }
      
      for (let i = 0; i < gridBrightness.length; i++) {
        gridBrightness[i] /= pixelsPerGrid;
      }
      
      // Simple edge detection (horizontal and vertical gradients)
      let edgeScore = 0;
      const sampleStep = 4;
      for (let y = 1; y < height - 1; y += sampleStep) {
        for (let x = 1; x < width - 1; x += sampleStep) {
          const idx = (y * width + x) * 4;
          const idxLeft = (y * width + (x - 1)) * 4;
          const idxRight = (y * width + (x + 1)) * 4;
          const idxUp = ((y - 1) * width + x) * 4;
          const idxDown = ((y + 1) * width + x) * 4;
          
          const gx = Math.abs((data[idxRight] + data[idxRight + 1] + data[idxRight + 2]) -
                              (data[idxLeft] + data[idxLeft + 1] + data[idxLeft + 2]));
          const gy = Math.abs((data[idxDown] + data[idxDown + 1] + data[idxDown + 2]) -
                              (data[idxUp] + data[idxUp + 1] + data[idxUp + 2]));
          
          edgeScore += Math.sqrt(gx * gx + gy * gy);
        }
      }
      edgeScore /= (width * height / (sampleStep * sampleStep));
      
      // Dominant color
      const colorCounts = {};
      for (let y = 0; y < height; y += 5) {
        for (let x = 0; x < width; x += 5) {
          const idx = (y * width + x) * 4;
          const r = Math.floor(data[idx] / 64) * 64;
          const g = Math.floor(data[idx + 1] / 64) * 64;
          const b = Math.floor(data[idx + 2] / 64) * 64;
          const key = `${r},${g},${b}`;
          colorCounts[key] = (colorCounts[key] || 0) + 1;
        }
      }
      
      let dominantColor = '0,0,0';
      let maxCount = 0;
      for (const [color, count] of Object.entries(colorCounts)) {
        if (count > maxCount) {
          maxCount = count;
          dominantColor = color;
        }
      }
      
      return {
        colorHist,
        gridBrightness,
        avgBrightness: totalBrightness / totalPixels,
        edgeScore,
        dominantColor,
        aspectRatio: width / height
      };
    }

    function compareFeatures(f1, f2) {
      if (!f1 || !f2) return 0;
      
      let score = 0;
      let totalWeight = 0;
      
      // Color histogram similarity (weight: 30)
      let colorSim = 0;
      for (let i = 0; i < f1.colorHist.length; i++) {
        colorSim += 1 - Math.abs(f1.colorHist[i] - f2.colorHist[i]);
      }
      colorSim /= f1.colorHist.length;
      score += colorSim * 30;
      totalWeight += 30;
      
      // Grid brightness similarity (weight: 25)
      let gridSim = 0;
      for (let i = 0; i < f1.gridBrightness.length; i++) {
        const diff = Math.abs(f1.gridBrightness[i] - f2.gridBrightness[i]) / 255;
        gridSim += 1 - diff;
      }
      gridSim /= f1.gridBrightness.length;
      score += gridSim * 25;
      totalWeight += 25;
      
      // Average brightness similarity (weight: 15)
      const brightDiff = Math.abs(f1.avgBrightness - f2.avgBrightness) / 255;
      score += (1 - brightDiff) * 15;
      totalWeight += 15;
      
      // Edge score similarity (weight: 15)
      const maxEdge = Math.max(f1.edgeScore, f2.edgeScore, 1);
      const edgeDiff = Math.abs(f1.edgeScore - f2.edgeScore) / maxEdge;
      score += (1 - edgeDiff) * 15;
      totalWeight += 15;
      
      // Dominant color match (weight: 10)
      if (f1.dominantColor === f2.dominantColor) {
        score += 10;
      } else {
        const c1 = f1.dominantColor.split(',').map(Number);
        const c2 = f2.dominantColor.split(',').map(Number);
        const colorDist = Math.sqrt(
          Math.pow(c1[0] - c2[0], 2) +
          Math.pow(c1[1] - c2[1], 2) +
          Math.pow(c1[2] - c2[2], 2)
        );
        score += Math.max(0, 10 - colorDist / 44); // Max distance ~442
      }
      totalWeight += 10;
      
      // Aspect ratio (weight: 5)
      const aspectDiff = Math.abs(f1.aspectRatio - f2.aspectRatio);
      score += Math.max(0, 5 - aspectDiff * 5);
      totalWeight += 5;
      
      return (score / totalWeight) * 100;
    }

    function extractFeaturesFromBase64(base64) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const size = 100; // Small size for fast processing
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, size, size);
          const imageData = ctx.getImageData(0, 0, size, size);
          resolve(extractImageFeatures(imageData));
        };
        img.onerror = () => resolve(null);
        img.src = base64;
      });
    }

    async function startVisualScan() {
      try {
        visualScanStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        
        const videoEl = document.getElementById('visualScanVideo');
        videoEl.srcObject = visualScanStream;
        document.getElementById('visualScanModal').classList.add('active');
      } catch (err) {
        showToast('Could not access camera: ' + err.message, 'error');
      }
    }

    function closeVisualScan() {
      if (visualScanStream) {
        visualScanStream.getTracks().forEach(track => track.stop());
        visualScanStream = null;
      }
      document.getElementById('visualScanVideo').srcObject = null;
      document.getElementById('visualScanModal').classList.remove('active');
    }

    async function captureForVisualMatch() {
      const video = document.getElementById('visualScanVideo');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      closeVisualScan();
      
      // Show matching overlay
      document.getElementById('matchingOverlay').classList.add('active');
      document.getElementById('matchingSpinner').style.display = 'block';
      document.getElementById('matchingText').textContent = 'Analyzing image...';
      document.getElementById('matchingResults').innerHTML = '';
      
      // Extract features from captured image
      const capturedData = ctx.getImageData(0, 0, 100, 100);
      const size = 100;
      const resizedCanvas = document.createElement('canvas');
      resizedCanvas.width = size;
      resizedCanvas.height = size;
      resizedCanvas.getContext('2d').drawImage(canvas, 0, 0, size, size);
      const capturedFeatures = extractImageFeatures(
        resizedCanvas.getContext('2d').getImageData(0, 0, size, size)
      );
      
      // Get all items and compare
      const items = await dbGetAll();
      const matches = [];
      
      for (const item of items) {
        if (item.photo && item.photoFeatures) {
          const score = compareFeatures(capturedFeatures, item.photoFeatures);
          if (score > 40) { // Threshold
            matches.push({ item, score });
          }
        } else if (item.photo) {
          // Extract features if not cached
          const features = await extractFeaturesFromBase64(item.photo);
          if (features) {
            item.photoFeatures = features;
            await dbPut(item);
            const score = compareFeatures(capturedFeatures, features);
            if (score > 40) {
              matches.push({ item, score });
            }
          }
        }
      }
      
      // Sort by score
      matches.sort((a, b) => b.score - a.score);
      
      // Show results
      document.getElementById('matchingSpinner').style.display = 'none';
      
      if (matches.length === 0) {
        document.getElementById('matchingText').textContent = 'No matches found';
        document.getElementById('matchingResults').innerHTML = `
          <div class="no-matches">
            <div class="icon">ðŸ”</div>
            <p>We couldn't find a matching keepsake.<br>Try taking a clearer photo or adjusting the lighting.</p>
          </div>
        `;
      } else {
        document.getElementById('matchingText').textContent = `Found ${matches.length} possible match${matches.length > 1 ? 'es' : ''}`;
        document.getElementById('matchingResults').innerHTML = matches.slice(0, 5).map(m => `
          <div class="match-item" onclick="selectMatch('${m.item.code}')">
            ${m.item.photo 
              ? `<img src="${m.item.photo}" alt="${m.item.name}">`
              : '<div class="no-img">ðŸ“¦</div>'}
            <div class="info">
              <h4>${m.item.name}</h4>
              <p>${m.item.from ? 'From ' + m.item.from : ''} ${m.item.year || ''}</p>
            </div>
            <span class="match-score">${Math.round(m.score)}%</span>
          </div>
        `).join('');
      }
    }

    function selectMatch(code) {
      closeMatchingOverlay();
      openDetail(code);
    }

    function closeMatchingOverlay() {
      document.getElementById('matchingOverlay').classList.remove('active');
    }

    /* ===========================
       Navigation
       =========================== */
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      
      document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
      document.getElementById('nav' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');

      if (page === 'library') renderLibrary();
      if (page === 'create') resetForm();
    }

    /* ===========================
       Form Steps
       =========================== */
    function updateSteps() {
      document.querySelectorAll('.step').forEach(s => {
        const step = parseInt(s.dataset.step);
        s.classList.remove('active', 'done');
        if (step === currentStep) s.classList.add('active');
        else if (step < currentStep) s.classList.add('done');
      });

      document.querySelectorAll('.form-step').forEach(s => {
        s.classList.remove('active');
        if (parseInt(s.dataset.step) === currentStep) s.classList.add('active');
      });

      document.getElementById('btnPrev').style.visibility = currentStep === 1 ? 'hidden' : 'visible';
      document.getElementById('btnNext').textContent = currentStep === totalSteps ? 'âœ“ Save Keepsake' : 'Next â†’';
      
      // Update review content on step 4
      if (currentStep === 4) {
        updateReview();
      }
    }

    function updateReview() {
      const name = document.getElementById('itemName').value.trim();
      const year = document.getElementById('itemYear').value.trim();
      const from = document.getElementById('itemFrom').value.trim();
      const category = document.getElementById('itemCategory').value;
      const speaker = document.getElementById('speakerName').value.trim();
      
      let html = '<div style="display: grid; gap: 0.75rem;">';
      html += `<div><strong>Name:</strong> ${name || '-'}</div>`;
      if (year) html += `<div><strong>Year:</strong> ${year}</div>`;
      if (from) html += `<div><strong>From:</strong> ${from}</div>`;
      if (category) html += `<div><strong>Category:</strong> ${category}</div>`;
      if (speaker) html += `<div><strong>Narrator:</strong> ${speaker}</div>`;
      html += `<div><strong>Photo:</strong> ${currentPhoto ? 'âœ“ Added' : 'None'}</div>`;
      html += `<div><strong>NFC:</strong> ${currentNfcId ? 'âœ“ Linked' : 'None'}</div>`;
      html += `<div><strong>Audio:</strong> ${currentAudioBlob ? 'âœ“ Recorded' : 'None'}</div>`;
      html += `<div><strong>Video:</strong> ${currentVideoBlob ? 'âœ“ Recorded' : 'None'}</div>`;
      html += '</div>';
      
      document.getElementById('reviewContent').innerHTML = html;
    }

    function getCreatePin() {
      let pin = '';
      for (let i = 0; i < 4; i++) {
        pin += document.getElementById('createPin' + i).value;
      }
      return pin;
    }

    function nextStep() {
      if (currentStep === 1) {
        const name = document.getElementById('itemName').value.trim();
        if (!name) {
          showToast('Please enter a name for your keepsake', 'error');
          return;
        }
        const pin = getCreatePin();
        if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
          showToast('Please enter a 4-digit PIN', 'error');
          return;
        }
      }
      
      if (currentStep < totalSteps) {
        currentStep++;
        updateSteps();
      } else {
        saveKeepsake();
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateSteps();
      }
    }

    /* ===========================
       PIN Input Handling
       =========================== */
    function setupPinInputs(prefix) {
      for (let i = 0; i < 4; i++) {
        const input = document.getElementById(prefix + i);
        if (!input) continue;
        
        input.addEventListener('input', (e) => {
          const val = e.target.value.replace(/\D/g, '');
          e.target.value = val;
          if (val.length === 1 && i < 3) {
            document.getElementById(prefix + (i + 1)).focus();
          }
        });
        
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && i > 0) {
            document.getElementById(prefix + (i - 1)).focus();
          }
        });
        
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, 4);
          for (let j = 0; j < paste.length && j < 4; j++) {
            document.getElementById(prefix + j).value = paste[j];
          }
          if (paste.length > 0) {
            document.getElementById(prefix + Math.min(paste.length - 1, 3)).focus();
          }
        });
      }
    }

    /* ===========================
       Camera
       =========================== */
    async function openCamera() {
      try {
        const constraints = {
          video: { 
            facingMode: facingMode, 
            width: { ideal: 1280 }, 
            height: { ideal: 720 } 
          },
          audio: false
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoEl = document.getElementById('cameraVideo');
        videoEl.srcObject = cameraStream;
        document.getElementById('cameraModal').classList.add('active');
      } catch (err) {
        showToast('Could not access camera: ' + err.message, 'error');
      }
    }

    async function switchCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        document.getElementById('cameraVideo').srcObject = cameraStream;
      } catch (err) {
        showToast('Could not switch camera', 'error');
      }
    }

    async function capturePhoto() {
      const video = document.getElementById('cameraVideo');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      currentPhoto = canvas.toDataURL('image/jpeg', 0.85);
      
      // Extract features for visual matching
      const size = 100;
      const featureCanvas = document.createElement('canvas');
      featureCanvas.width = size;
      featureCanvas.height = size;
      featureCanvas.getContext('2d').drawImage(canvas, 0, 0, size, size);
      currentPhotoFeatures = extractImageFeatures(
        featureCanvas.getContext('2d').getImageData(0, 0, size, size)
      );
      
      document.getElementById('photoPreview').src = currentPhoto;
      document.getElementById('photoPreviewContainer').classList.add('has-photo');
      document.getElementById('photoOptions').style.display = 'none';
      
      closeCamera();
      showToast('Photo captured!', 'success');
    }

    function closeCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      document.getElementById('cameraVideo').srcObject = null;
      document.getElementById('cameraModal').classList.remove('active');
    }

    async function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        currentPhoto = e.target.result;
        document.getElementById('photoPreview').src = currentPhoto;
        document.getElementById('photoPreviewContainer').classList.add('has-photo');
        document.getElementById('photoOptions').style.display = 'none';
        
        // Extract features
        currentPhotoFeatures = await extractFeaturesFromBase64(currentPhoto);
      };
      reader.readAsDataURL(file);
    }

    function clearPhoto() {
      currentPhoto = null;
      currentPhotoFeatures = null;
      document.getElementById('photoPreview').src = '';
      document.getElementById('photoPreviewContainer').classList.remove('has-photo');
      document.getElementById('photoOptions').style.display = 'grid';
    }

    /* ===========================
       Audio Recording
       =========================== */
    function createVisualizer() {
      const visualizer = document.getElementById('audioVisualizer');
      visualizer.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = '4px';
        visualizer.appendChild(bar);
      }
    }

    function startVisualization() {
      const visualizer = document.getElementById('audioVisualizer');
      const bars = visualizer.querySelectorAll('.bar');
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        
        const step = Math.floor(bufferLength / bars.length);
        bars.forEach((bar, i) => {
          const value = dataArray[i * step];
          const height = Math.max(4, (value / 255) * 60);
          bar.style.height = height + 'px';
        });
      }
      draw();
    }

    function stopVisualization() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    function updateTimer() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const mins = Math.floor(elapsed / 60);
      const secs = elapsed % 60;
      document.getElementById('audioTimer').textContent = 
        `Recording... ${mins}:${secs.toString().padStart(2, '0')}`;
    }

    async function toggleAudioRecording() {
      const btn = document.getElementById('btnRecordAudio');
      const visualizerContainer = document.getElementById('audioVisualizerContainer');

      if (isRecordingAudio) {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
        btn.innerHTML = 'ðŸŽ¤ Record Audio';
        btn.classList.remove('recording');
        visualizerContainer.classList.remove('active');
        stopVisualization();
        clearInterval(timerInterval);
        isRecordingAudio = false;
      } else {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            } 
          });
          recordedChunks = [];
          
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const source = audioContext.createMediaStreamSource(mediaStream);
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 256;
          source.connect(analyser);
          
          createVisualizer();
          visualizerContainer.classList.add('active');
          startVisualization();
          
          let mimeType = 'audio/webm;codecs=opus';
          if (!MediaRecorder.isTypeSupported(mimeType)) {
            mimeType = 'audio/webm';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
              mimeType = 'audio/mp4';
              if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = '';
              }
            }
          }
          
          const options = mimeType ? { mimeType } : {};
          mediaRecorder = new MediaRecorder(mediaStream, options);

          mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
              recordedChunks.push(e.data);
            }
          };

          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: mimeType || 'audio/webm' });
            currentAudioBlob = blob;
            
            const audioUrl = URL.createObjectURL(blob);
            document.getElementById('audioPlayer').src = audioUrl;
            document.getElementById('audioPlayback').classList.add('active');
            
            if (mediaStream) {
              mediaStream.getTracks().forEach(track => track.stop());
              mediaStream = null;
            }
            if (audioContext) {
              audioContext.close();
              audioContext = null;
            }
          };

          mediaRecorder.start(250);
          
          recordingStartTime = Date.now();
          timerInterval = setInterval(updateTimer, 1000);
          
          btn.innerHTML = 'â¹ Stop Recording';
          btn.classList.add('recording');
          isRecordingAudio = true;
        } catch (err) {
          showToast('Could not access microphone: ' + err.message, 'error');
        }
      }
    }

    function clearAudio() {
      currentAudioBlob = null;
      const player = document.getElementById('audioPlayer');
      if (player.src) URL.revokeObjectURL(player.src);
      player.src = '';
      document.getElementById('audioPlayback').classList.remove('active');
    }

    /* ===========================
       Video Recording
       =========================== */
    async function toggleVideoRecording() {
      const btn = document.getElementById('btnRecordVideo');
      const previewContainer = document.getElementById('videoPreviewContainer');
      const previewVideo = document.getElementById('videoPreviewLive');

      if (isRecordingVideo) {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
        btn.innerHTML = 'ðŸŽ¥ Record Video';
        btn.classList.remove('recording');
        previewContainer.classList.remove('active');
        previewVideo.srcObject = null;
        isRecordingVideo = false;
      } else {
        try {
          mediaStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: true
          });
          recordedChunks = [];
          
          previewVideo.srcObject = mediaStream;
          previewContainer.classList.add('active');
          
          let mimeType = 'video/webm;codecs=vp9,opus';
          if (!MediaRecorder.isTypeSupported(mimeType)) {
            mimeType = 'video/webm;codecs=vp8,opus';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
              mimeType = 'video/webm';
              if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'video/mp4';
              }
            }
          }
          
          const options = mimeType ? { mimeType } : {};
          mediaRecorder = new MediaRecorder(mediaStream, options);

          mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) recordedChunks.push(e.data);
          };

          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: mimeType || 'video/webm' });
            currentVideoBlob = blob;
            
            const videoUrl = URL.createObjectURL(blob);
            document.getElementById('videoPlayer').src = videoUrl;
            document.getElementById('videoPlayback').classList.add('active');
            
            if (mediaStream) {
              mediaStream.getTracks().forEach(track => track.stop());
              mediaStream = null;
            }
          };

          mediaRecorder.start(250);
          btn.innerHTML = 'â¹ Stop Recording';
          btn.classList.add('recording');
          isRecordingVideo = true;
        } catch (err) {
          showToast('Could not access camera: ' + err.message, 'error');
        }
      }
    }

    function clearVideo() {
      currentVideoBlob = null;
      const player = document.getElementById('videoPlayer');
      if (player.src) URL.revokeObjectURL(player.src);
      player.src = '';
      document.getElementById('videoPlayback').classList.remove('active');
    }

    /* ===========================
       Helpers
       =========================== */
    function generateCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function base64ToBlob(base64) {
      try {
        const parts = base64.split(';base64,');
        const contentType = parts[0].split(':')[1];
        const raw = window.atob(parts[1]);
        const rawLength = raw.length;
        const uInt8Array = new Uint8Array(rawLength);
        
        for (let i = 0; i < rawLength; ++i) {
          uInt8Array[i] = raw.charCodeAt(i);
        }
        
        return new Blob([uInt8Array], { type: contentType });
      } catch (e) {
        console.error('Error converting base64 to blob:', e);
        return null;
      }
    }

    /* ===========================
       Save Keepsake
       =========================== */
    async function saveKeepsake() {
      const name = document.getElementById('itemName').value.trim();
      if (!name) {
        showToast('Please enter a name', 'error');
        return;
      }

      const pin = getCreatePin();
      if (pin.length !== 4) {
        showToast('Please enter a 4-digit PIN', 'error');
        return;
      }

      const code = generateCode();
      
      let audioData = null;
      let videoData = null;
      
      if (currentAudioBlob) {
        try { audioData = await blobToBase64(currentAudioBlob); } 
        catch (e) { console.error('Audio conversion error:', e); }
      }
      
      if (currentVideoBlob) {
        try { videoData = await blobToBase64(currentVideoBlob); } 
        catch (e) { console.error('Video conversion error:', e); }
      }

      const keepsake = {
        code,
        pin,
        name,
        year: document.getElementById('itemYear').value.trim(),
        from: document.getElementById('itemFrom').value.trim(),
        category: document.getElementById('itemCategory').value,
        note: document.getElementById('itemNote').value.trim(),
        speaker: document.getElementById('speakerName').value.trim(),
        photo: currentPhoto,
        photoFeatures: currentPhotoFeatures,
        audio: audioData,
        video: videoData,
        nfcId: currentNfcId,
        createdAt: new Date().toISOString()
      };

      try {
        await dbPut(keepsake);
        currentQRCode = code;
        showToast('Keepsake saved!', 'success');
        resetForm();
        showQrModal(code);
      } catch (err) {
        showToast('Error saving: ' + err.message, 'error');
      }
    }

    function resetForm() {
      currentStep = 1;
      document.getElementById('itemName').value = '';
      document.getElementById('itemYear').value = '';
      document.getElementById('itemFrom').value = '';
      document.getElementById('itemCategory').value = '';
      document.getElementById('itemNote').value = '';
      document.getElementById('speakerName').value = '';
      for (let i = 0; i < 4; i++) {
        document.getElementById('createPin' + i).value = '';
      }
      currentNfcId = null;
      document.getElementById('nfcStatusText').textContent = 'No NFC tag linked';
      document.getElementById('nfcStatusHint').textContent = 'Tap button below to scan an NFC tag';
      document.getElementById('nfcIdDisplay').style.display = 'none';
      document.getElementById('btnScanNfc').textContent = 'ðŸ“¡ Scan NFC Tag';
      clearPhoto();
      clearAudio();
      clearVideo();
      document.getElementById('photoOptions').style.display = 'grid';
      updateSteps();
    }

    /* ===========================
       Library
       =========================== */
    async function renderLibrary() {
      const items = await dbGetAll();
      const grid = document.getElementById('keepsakeGrid');
      const empty = document.getElementById('emptyState');
      
      document.getElementById('statTotal').textContent = items.length;
      document.getElementById('statNfc').textContent = items.filter(i => i.nfcId).length;
      document.getElementById('statAudio').textContent = items.filter(i => i.audio).length;
      document.getElementById('statVideo').textContent = items.filter(i => i.video).length;

      if (items.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        document.getElementById('libraryStats').style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      document.getElementById('libraryStats').style.display = 'flex';
      
      items.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
      
      grid.innerHTML = items.map(item => `
        <div class="keepsake-card" onclick="openDetail('${item.code}')">
          <div class="keepsake-thumb">
            ${item.photo 
              ? `<img src="${item.photo}" alt="${item.name}" />`
              : '<span class="no-photo">ðŸ“¦</span>'}
            <div class="keepsake-badges">
              ${item.nfcId ? '<span class="badge nfc">ðŸ“¡ NFC</span>' : ''}
              ${item.audio ? '<span class="badge">ðŸŽ¤</span>' : ''}
              ${item.video ? '<span class="badge">ðŸŽ¬</span>' : ''}
            </div>
          </div>
          <div class="keepsake-info">
            <h3>${item.name}</h3>
            <div class="keepsake-meta">
              ${item.year ? `<span>${item.year}</span>` : ''}
              ${item.from ? `<span>from ${item.from}</span>` : ''}
              <span class="keepsake-code">${item.code}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    /* ===========================
       Detail Modal
       =========================== */
    async function openDetail(code) {
      const item = await dbGet(code);
      if (!item) {
        showToast('Keepsake not found', 'error');
        return;
      }
      
      currentKeepsake = item;
      
      if (detailVideoBlobUrl) {
        URL.revokeObjectURL(detailVideoBlobUrl);
        detailVideoBlobUrl = null;
      }
      
      document.getElementById('flipCard').classList.remove('flipped');
      
      const frontPhoto = document.getElementById('cardFrontPhoto');
      if (item.photo) {
        frontPhoto.innerHTML = `
          <button class="card-front-close" onclick="event.stopPropagation(); closeDetail()">Ã—</button>
          <img src="${item.photo}" alt="${item.name}" />
        `;
      } else {
        frontPhoto.innerHTML = `
          <button class="card-front-close" onclick="event.stopPropagation(); closeDetail()">Ã—</button>
          <span class="no-photo">ðŸ“¦</span>
        `;
      }
      
      document.getElementById('cardFrontName').textContent = item.name;
      document.getElementById('cardFrontCode').textContent = item.code;
      
      // Badges
      let badgesHtml = '';
      if (item.nfcId) badgesHtml += '<span class="badge nfc">ðŸ“¡ NFC</span>';
      if (item.audio) badgesHtml += '<span class="badge">ðŸŽ¤ Audio</span>';
      if (item.video) badgesHtml += '<span class="badge">ðŸŽ¬ Video</span>';
      document.getElementById('cardFrontBadges').innerHTML = badgesHtml;
      
      // Back - Details
      let rowsHtml = '';
      if (item.year) rowsHtml += `<div class="detail-row"><span class="label">Year</span><span class="value">${item.year}</span></div>`;
      if (item.from) rowsHtml += `<div class="detail-row"><span class="label">From</span><span class="value">${item.from}</span></div>`;
      if (item.category) rowsHtml += `<div class="detail-row"><span class="label">Category</span><span class="value">${item.category}</span></div>`;
      if (item.speaker) rowsHtml += `<div class="detail-row"><span class="label">Narrator</span><span class="value">${item.speaker}</span></div>`;
      if (item.note) rowsHtml += `<div class="detail-row"><span class="label">Note</span><span class="value">${item.note}</span></div>`;
      if (item.nfcId) rowsHtml += `<div class="detail-row"><span class="label">NFC ID</span><span class="value" style="font-size: 0.7rem; word-break: break-all;">${item.nfcId}</span></div>`;
      document.getElementById('detailRows').innerHTML = rowsHtml;
      
      // Audio
      const audioSection = document.getElementById('detailAudioSection');
      const audioEl = document.getElementById('detailAudio');
      if (item.audio) {
        audioEl.src = item.audio;
        audioSection.style.display = 'block';
      } else {
        audioEl.src = '';
        audioSection.style.display = 'none';
      }
      
      // Video
      const videoSection = document.getElementById('detailVideoSection');
      const videoEl = document.getElementById('detailVideo');
      if (item.video) {
        const videoBlob = base64ToBlob(item.video);
        if (videoBlob) {
          detailVideoBlobUrl = URL.createObjectURL(videoBlob);
          videoEl.src = detailVideoBlobUrl;
        } else {
          videoEl.src = item.video;
        }
        videoSection.style.display = 'block';
      } else {
        videoEl.src = '';
        videoSection.style.display = 'none';
      }
      
      // NFC button visibility
      document.getElementById('detailNfcBtn').style.display = nfcSupported ? 'flex' : 'none';
      
      document.getElementById('detailOverlay').classList.add('active');
    }

    function flipCard() {
      document.getElementById('flipCard').classList.toggle('flipped');
    }

    function closeDetail() {
      document.getElementById('detailOverlay').classList.remove('active');
      
      const audioEl = document.getElementById('detailAudio');
      const videoEl = document.getElementById('detailVideo');
      
      audioEl.pause();
      audioEl.currentTime = 0;
      videoEl.pause();
      videoEl.currentTime = 0;
      
      setTimeout(() => {
        document.getElementById('flipCard').classList.remove('flipped');
      }, 400);
    }

    function showQrForCurrent() {
      if (currentKeepsake) {
        closeDetail();
        setTimeout(() => showQrModal(currentKeepsake.code), 300);
      }
    }

    /* ===========================
       Code Lookup
       =========================== */
    function openCodeLookup() {
      document.getElementById('codeLookupInput').value = '';
      openModal('codeLookupModal');
    }

    async function lookupCode() {
      const code = document.getElementById('codeLookupInput').value.trim().toUpperCase();
      if (!code) {
        showToast('Please enter a code', 'error');
        return;
      }
      
      const item = await dbGet(code);
      if (item) {
        closeModal('codeLookupModal');
        openDetail(code);
      } else {
        showToast('Keepsake not found', 'error');
      }
    }

    /* ===========================
       PIN Verification
       =========================== */
    function promptPinForEdit() {
      pendingPinAction = 'edit';
      document.getElementById('pinModalMessage').textContent = 'Enter the 4-digit PIN to edit this keepsake';
      clearPinInputs();
      document.getElementById('pinError').classList.remove('visible');
      openModal('pinModal');
      setTimeout(() => document.getElementById('verifyPin0').focus(), 100);
    }

    function promptPinForDelete() {
      pendingPinAction = 'delete';
      document.getElementById('pinModalMessage').textContent = 'Enter the 4-digit PIN to delete this keepsake';
      clearPinInputs();
      document.getElementById('pinError').classList.remove('visible');
      openModal('pinModal');
      setTimeout(() => document.getElementById('verifyPin0').focus(), 100);
    }

    function clearPinInputs() {
      for (let i = 0; i < 4; i++) {
        document.getElementById('verifyPin' + i).value = '';
      }
    }

    function getVerifyPin() {
      let pin = '';
      for (let i = 0; i < 4; i++) {
        pin += document.getElementById('verifyPin' + i).value;
      }
      return pin;
    }

    function verifyPin() {
      const enteredPin = getVerifyPin();
      
      if (enteredPin.length !== 4) {
        document.getElementById('pinError').textContent = 'Please enter all 4 digits';
        document.getElementById('pinError').classList.add('visible');
        return;
      }
      
      if (!currentKeepsake) {
        closeModal('pinModal');
        return;
      }
      
      const storedPin = currentKeepsake.pin || '0000';
      
      if (enteredPin === storedPin) {
        closeModal('pinModal');
        document.getElementById('pinError').classList.remove('visible');
        
        if (pendingPinAction === 'edit') {
          openEditModal();
        } else if (pendingPinAction === 'delete') {
          deleteKeepsake();
        }
      } else {
        document.getElementById('pinError').textContent = 'Incorrect PIN. Please try again.';
        document.getElementById('pinError').classList.add('visible');
        clearPinInputs();
        document.getElementById('verifyPin0').focus();
      }
    }

    /* ===========================
       Edit Keepsake
       =========================== */
    function openEditModal() {
      if (!currentKeepsake) return;
      
      document.getElementById('editName').value = currentKeepsake.name || '';
      document.getElementById('editYear').value = currentKeepsake.year || '';
      document.getElementById('editFrom').value = currentKeepsake.from || '';
      document.getElementById('editCategory').value = currentKeepsake.category || '';
      document.getElementById('editNote').value = currentKeepsake.note || '';
      document.getElementById('editSpeaker').value = currentKeepsake.speaker || '';
      
      closeDetail();
      setTimeout(() => openModal('editModal'), 300);
    }

    async function saveEdit() {
      if (!currentKeepsake) return;
      
      currentKeepsake.name = document.getElementById('editName').value.trim();
      currentKeepsake.year = document.getElementById('editYear').value.trim();
      currentKeepsake.from = document.getElementById('editFrom').value.trim();
      currentKeepsake.category = document.getElementById('editCategory').value;
      currentKeepsake.note = document.getElementById('editNote').value.trim();
      currentKeepsake.speaker = document.getElementById('editSpeaker').value.trim();
      
      try {
        await dbPut(currentKeepsake);
        closeModal('editModal');
        showToast('Keepsake updated!', 'success');
        renderLibrary();
      } catch (err) {
        showToast('Error saving: ' + err.message, 'error');
      }
    }

    async function deleteKeepsake() {
      if (!currentKeepsake) return;
      
      if (!confirm('Delete this keepsake? This cannot be undone.')) return;
      
      try {
        await dbDelete(currentKeepsake.code);
        closeDetail();
        showToast('Keepsake deleted', 'success');
        renderLibrary();
      } catch (err) {
        showToast('Error deleting: ' + err.message, 'error');
      }
    }

    async function exportSingle() {
      if (!currentKeepsake) return;
      
      const exportData = { ...currentKeepsake };
      delete exportData.pin;
      
      const data = JSON.stringify([exportData], null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `keepsake-${currentKeepsake.code}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      showToast('Exported successfully', 'success');
    }

    /* ===========================
       QR Code
       =========================== */
    function showQrModal(code) {
      currentQRCode = code;
      document.getElementById('qrCodeValue').textContent = code;
      
      const container = document.getElementById('qrContainer');
      container.innerHTML = '';
      
      try {
        new QRCode(container, {
          text: code,
          width: 200,
          height: 200,
          colorDark: '#1a1a2e',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (err) {
        console.error('QR generation error:', err);
        container.innerHTML = '<p style="color: red;">Error generating QR code.</p>';
      }
      
      openModal('qrModal');
    }

    function copyCode() {
      navigator.clipboard.writeText(currentQRCode).then(() => {
        showToast('Code copied!', 'success');
      });
    }

    function downloadQR() {
      const container = document.getElementById('qrContainer');
      const img = container.querySelector('img');
      const canvas = container.querySelector('canvas');
      
      let dataUrl;
      if (canvas) {
        dataUrl = canvas.toDataURL('image/png');
      } else if (img) {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = img.width;
        tempCanvas.height = img.height;
        const ctx = tempCanvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        dataUrl = tempCanvas.toDataURL('image/png');
      }
      
      if (dataUrl) {
        const link = document.createElement('a');
        link.download = 'keepsake-' + currentQRCode + '.png';
        link.href = dataUrl;
        link.click();
        showToast('QR downloaded', 'success');
      } else {
        showToast('Could not download QR', 'error');
      }
    }

    /* ===========================
       Export / Import
       =========================== */
    function openExportModal() {
      openModal('exportModal');
    }

    function openImportModal() {
      openModal('importModal');
    }

    async function exportAll() {
      const items = await dbGetAll();
      if (items.length === 0) {
        showToast('No keepsakes to export', 'error');
        return;
      }
      
      const exportItems = items.map(item => {
        const copy = { ...item };
        delete copy.pin;
        return copy;
      });
      
      const data = JSON.stringify(exportItems, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `keepsake-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      closeModal('exportModal');
      showToast(`Exported ${items.length} keepsakes`, 'success');
    }

    async function exportList() {
      const items = await dbGetAll();
      if (items.length === 0) {
        showToast('No keepsakes to export', 'error');
        return;
      }
      
      const headers = ['Code', 'Name', 'Year', 'From', 'Category', 'Speaker', 'NFC', 'Has Photo', 'Has Audio', 'Has Video', 'Created'];
      const rows = items.map(i => [
        i.code,
        `"${(i.name || '').replace(/"/g, '""')}"`,
        i.year || '',
        `"${(i.from || '').replace(/"/g, '""')}"`,
        i.category || '',
        `"${(i.speaker || '').replace(/"/g, '""')}"`,
        i.nfcId ? 'Yes' : 'No',
        i.photo ? 'Yes' : 'No',
        i.audio ? 'Yes' : 'No',
        i.video ? 'Yes' : 'No',
        i.createdAt || ''
      ].join(','));
      
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `keepsake-list-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      URL.revokeObjectURL(url);
      closeModal('exportModal');
      showToast(`Exported ${items.length} keepsakes`, 'success');
    }

    async function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const items = JSON.parse(text);
        
        if (!Array.isArray(items)) {
          throw new Error('Invalid format');
        }
        
        let imported = 0;
        for (const item of items) {
          if (item.code && item.name) {
            if (!item.pin) {
              item.pin = '0000';
            }
            await dbPut(item);
            imported++;
          }
        }
        
        closeModal('importModal');
        showToast(`Imported ${imported} keepsakes`, 'success');
        renderLibrary();
      } catch (err) {
        showToast('Error importing: ' + err.message, 'error');
      }
      
      event.target.value = '';
    }

    /* ===========================
       Modal Helpers
       =========================== */
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    /* ===========================
       Toast
       =========================== */
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    /* ===========================
       Drop zone
       =========================== */
    const dropZone = document.getElementById('importDropZone');
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.json')) {
        handleImport({ target: { files: [file], value: '' } });
      }
    });

    /* ===========================
       Initialize
       =========================== */
    openDB().then(() => {
      console.log('Database ready');
      setupPinInputs('createPin');
      setupPinInputs('verifyPin');
      checkNfcSupport();
    }).catch(err => {
      console.error('Database error:', err);
    });
  </script>


</body></html>